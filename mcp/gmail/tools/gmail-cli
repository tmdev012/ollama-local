#!/usr/bin/env python3
"""Gmail CLI - Search and export emails for AI context"""

import os
import sys
import json
import argparse
from datetime import datetime

try:
    from google.oauth2.credentials import Credentials
    from googleapiclient.discovery import build
except ImportError:
    print("Run: pip3 install google-auth-oauthlib google-api-python-client")
    sys.exit(1)

CONFIG_DIR = os.path.expanduser('~/ollama-local/mcp/gmail/config')
TOKEN_FILE = os.path.join(CONFIG_DIR, 'token.json')
DB_PATH = os.path.expanduser('~/ollama-local/db/history.db')

def get_service():
    """Get authenticated Gmail service"""
    if not os.path.exists(TOKEN_FILE):
        print("Not authenticated. Run: ~/ollama-local/mcp/gmail/tools/gmail-setup")
        sys.exit(1)

    creds = Credentials.from_authorized_user_file(TOKEN_FILE)
    return build('gmail', 'v1', credentials=creds)

def search_emails(query, max_results=10):
    """Search emails by query"""
    service = get_service()
    results = service.users().messages().list(
        userId='me', q=query, maxResults=max_results
    ).execute()

    messages = results.get('messages', [])
    emails = []

    for msg in messages:
        detail = service.users().messages().get(
            userId='me', id=msg['id'], format='full'
        ).execute()

        headers = {h['name']: h['value'] for h in detail['payload']['headers']}

        # Get body
        body = ""
        if 'parts' in detail['payload']:
            for part in detail['payload']['parts']:
                if part['mimeType'] == 'text/plain':
                    import base64
                    body = base64.urlsafe_b64decode(part['body'].get('data', '')).decode('utf-8', errors='ignore')
                    break
        elif 'body' in detail['payload'] and 'data' in detail['payload']['body']:
            import base64
            body = base64.urlsafe_b64decode(detail['payload']['body']['data']).decode('utf-8', errors='ignore')

        emails.append({
            'id': msg['id'],
            'date': headers.get('Date', ''),
            'from': headers.get('From', ''),
            'subject': headers.get('Subject', ''),
            'snippet': detail.get('snippet', ''),
            'body': body[:2000]  # Limit body size
        })

    return emails

def recent_emails(count=10):
    """Get recent emails"""
    return search_emails('', max_results=count)

def export_context(query, output_file=None):
    """Export emails as context for AI"""
    emails = search_emails(query, max_results=20)

    context = f"# Email Context: {query}\n"
    context += f"# Exported: {datetime.now().isoformat()}\n\n"

    for email in emails:
        context += f"---\n"
        context += f"From: {email['from']}\n"
        context += f"Date: {email['date']}\n"
        context += f"Subject: {email['subject']}\n"
        context += f"\n{email['body']}\n\n"

    if output_file:
        with open(output_file, 'w') as f:
            f.write(context)
        print(f"Exported to: {output_file}")
    else:
        print(context)

def list_labels():
    """List Gmail labels"""
    service = get_service()
    results = service.users().labels().list(userId='me').execute()
    labels = results.get('labels', [])

    for label in labels:
        print(f"{label['id']}: {label['name']}")

def main():
    parser = argparse.ArgumentParser(description='Gmail CLI for AI context')
    subparsers = parser.add_subparsers(dest='command', help='Commands')

    # Search
    search_parser = subparsers.add_parser('search', help='Search emails')
    search_parser.add_argument('query', help='Search query')
    search_parser.add_argument('-n', '--count', type=int, default=10, help='Max results')

    # Recent
    recent_parser = subparsers.add_parser('recent', help='Get recent emails')
    recent_parser.add_argument('-n', '--count', type=int, default=10, help='Number of emails')

    # Export
    export_parser = subparsers.add_parser('export', help='Export emails as context')
    export_parser.add_argument('query', help='Search query')
    export_parser.add_argument('-o', '--output', help='Output file')

    # Labels
    subparsers.add_parser('labels', help='List Gmail labels')

    args = parser.parse_args()

    if args.command == 'search':
        emails = search_emails(args.query, args.count)
        for e in emails:
            print(f"\n[{e['date']}] {e['from']}")
            print(f"  Subject: {e['subject']}")
            print(f"  {e['snippet'][:100]}...")

    elif args.command == 'recent':
        emails = recent_emails(args.count)
        for e in emails:
            print(f"\n[{e['date']}] {e['from']}")
            print(f"  Subject: {e['subject']}")

    elif args.command == 'export':
        export_context(args.query, args.output)

    elif args.command == 'labels':
        list_labels()

    else:
        parser.print_help()

if __name__ == '__main__':
    main()
